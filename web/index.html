<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CasaFin • Entrada</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <style>
    :root { --fg:#111; --muted:#666; --line:#eee; --bg:#fff; }
    * { box-sizing:border-box }
    body { font-family:system-ui,Segoe UI,Roboto,Arial; color:var(--fg); background:var(--bg);
           max-width:420px; margin:56px auto; padding:0 16px }
    h1 { margin:0 0 16px }
    .card { border:1px solid var(--line); border-radius:14px; padding:16px; }
    label { font-size:12px; color:var(--muted) }
    input,button { width:100%; padding:10px; margin:8px 0 }
    .hint { font-size:12px; color:var(--muted); text-align:center; margin-top:6px }
    a { color:#246; text-decoration:underline }
  </style>
</head>
<body>
  <h1>CasaFin</h1>
  <form id="login-form" class="card">
    <label>E-mail</label>
    <input id="email" type="email" placeholder="seu@email.com" autocomplete="username" required />
    <label>Senha</label>
    <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" required />
    <button id="btn-login" type="submit">Entrar</button>
    <div class="hint"><a href="./forgot-password.html">Esqueceu a senha?</a></div>
  </form>

  <script type="module">
    const { SUPABASE_URL, SUPABASE_ANON_KEY, APP_BASE_URL } = window.CASAFIN;
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // já logado?
    const { data: u0 } = await supabase.auth.getUser();
    if (u0?.user) await postLoginRedirect();

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);
      await postLoginRedirect();
    });

    async function postLoginRedirect() {
      const { data: u } = await supabase.auth.getUser();
      if (!u?.user) return;
      const { data: ms, error } = await supabase
        .from('memberships')
        .select('role')
        .eq('user_id', u.user.id)
        .eq('approved', true);

      if (error) return location.href = `${APP_BASE_URL}/app.html`;
      const roles = (ms || []).map(m => m.role);
      if (roles.includes('owner')) location.href = `${APP_BASE_URL}/owner-panel.html`;
      else location.href = `${APP_BASE_URL}/app.html`;
    }
  </script>
</body>
</html>
