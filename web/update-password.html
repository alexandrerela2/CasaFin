<!-- web/update-password.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CasaFin • Redefinir senha</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>
  <script src="./config.js"></script>
  <style>
    :root { --fg:#111; --muted:#666; --line:#eee; --bg:#fff; }
    body { font-family:system-ui,Segoe UI,Roboto,Arial; color:var(--fg); background:var(--bg);
           max-width:520px; margin:48px auto; padding:0 16px }
    .card { border:1px solid var(--line); border-radius:14px; padding:16px; margin:16px 0 }
    label { font-size:12px; color:var(--muted) }
    input,button { width:100%; padding:10px; margin:6px 0 }
    .hint { font-size:12px; color:var(--muted) }
  </style>
</head>
<body>
  <h1>Redefinir senha</h1>
  <p class="hint">Use esta página abrindo o <b>link do e-mail</b> de recuperação.</p>

  <div class="card">
    <label>Nova senha</label>
    <input id="pwd1" type="password" placeholder="nova senha" />
    <label>Confirmar nova senha</label>
    <input id="pwd2" type="password" placeholder="repita a nova senha" />
    <button id="btn-set">Salvar nova senha</button>
    <p id="status" class="hint"></p>
  </div>

  <script type="module">
    const { SUPABASE_URL, SUPABASE_ANON_KEY, APP_BASE_URL } = window.CASAFIN;
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const statusEl = document.getElementById('status');

    // Quando você abre pelo link do e-mail, o Supabase cria uma sessão "de recuperação".
    // Checamos se há sessão; se não houver, avisamos para abrir pelo link do e-mail.
    async function ensureRecoverySession() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        statusEl.textContent = 'Sessão de recuperação não encontrada. Abra esta página a partir do link recebido por e-mail ou solicite a recuperação novamente.';
      }
    }
    await ensureRecoverySession();

    document.getElementById('btn-set').onclick = async () => {
      const p1 = document.getElementById('pwd1').value;
      const p2 = document.getElementById('pwd2').value;
      if (!p1 || !p2) return alert('Informe e confirme a nova senha.');
      if (p1 !== p2) return alert('As senhas não coincidem.');

      // Define a nova senha na sessão atual (criada pelo link do e-mail)
      const { data, error } = await supabase.auth.updateUser({ password: p1 });
      if (error) return alert(error.message);

      alert('Senha alterada com sucesso! Faça login novamente.');
      location.href = `${APP_BASE_URL}/index.html`;
    };
  </script>
</body>
</html>
