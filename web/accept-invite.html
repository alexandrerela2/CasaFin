<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CasaFin — Aceitando convite…</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#f7f7fb; color:#1f2328; }
    .wrap { max-width: 520px; margin: 12vh auto; background:#fff; padding:28px; border-radius:14px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    h1 { font-size: 22px; margin: 0 0 10px; }
    p.muted { color:#6a737d; }
    .ok { color:#1f883d; font-weight:600; }
    .err { color:#b42318; font-weight:600; }
    .spinner { display:inline-block; width:18px; height:18px; border:3px solid #e5e7eb; border-top-color:#1f883d; border-radius:50%; animation: spin 1s linear infinite; vertical-align:-3px; margin-right:8px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    a.btn { display:inline-block; padding:10px 14px; border-radius:10px; background:#1f883d; color:#fff; text-decoration:none; font-weight:600; }
  </style>
  <!-- Carrega variáveis do projeto (SUPABASE_URL/ANON_KEY/APP_BASE_URL) -->
  <script src="./config.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Processando seu convite…</h1>
    <p class="muted">Se algo der errado, você poderá tentar novamente pelo link do e-mail.</p>
    <p id="status" class="muted"><span class="spinner"></span>Iniciando…</p>
    <p id="fallback" style="display:none">
      Se permanecer nesta tela, clique para <a id="toPassword" class="btn" href="#">definir sua senha</a>.
    </p>
  </div>

  <script type="module">
    import { supabase } from "./lib/supabase.js";

    const statusEl = document.getElementById("status");
    const fbWrap = document.getElementById("fallback");
    const toPwd = document.getElementById("toPassword");

    function setStatus(msg, cls="muted"){
      statusEl.className = cls;
      statusEl.innerHTML = msg;
    }

    // 1) Ler token do convite da querystring
    const params = new URLSearchParams(location.search);
    const token = params.get("token");
    if (!token) {
      alert("Link inválido: token ausente.");
      location.href = "/";
    }

    // Fallback para ir definir senha (caso a sessão não esteja ativa)
    const nextAfterPwd = `/accept-invite.html?token=${encodeURIComponent(token)}`;
    toPwd.href = `/update-password.html?next=${encodeURIComponent(nextAfterPwd)}`;

    // 2) Se o Supabase trouxe tokens no hash (#access_token/#refresh_token), salvar sessão
    async function ensureSessionFromHash() {
      const hash = new URLSearchParams(location.hash.replace(/^#/, ""));
      const access_token = hash.get("access_token");
      const refresh_token = hash.get("refresh_token");
      if (access_token && refresh_token) {
        await supabase.auth.setSession({ access_token, refresh_token });
        // Limpa o hash para não reprocessar
        history.replaceState({}, document.title, location.pathname + location.search);
      }
    }

    // 3) Executar aceite do convite
    async function acceptInvite() {
      setStatus(`<span class="spinner"></span>Checando sessão…`);
      await ensureSessionFromHash();

      let { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        // Sem sessão → usuário precisa abrir pelo link do e-mail e (se necessário) definir a senha
        setStatus("Sessão não encontrada. Abra o link do e-mail e defina sua senha antes de aceitar o convite.", "err");
        fbWrap.style.display = "block";
        return;
      }

      try {
        setStatus(`<span class="spinner"></span>Validando convite…`);
        // >>> Etapa 3: chamada exata da RPC com { token }
        const { data, error } = await supabase.rpc("accept_invite", { token });

        if (error) {
          console.error(error);
          alert(error.message);
          setStatus("Falha ao aceitar convite. Tente novamente a partir do e-mail.", "err");
          fbWrap.style.display = "block";
          return;
        }

        // Se a função retorna boolean (V5), 'data' deve ser true em sucesso
        if (data !== true) {
          // Tratar qualquer retorno inesperado como erro genérico
          setStatus("Não foi possível concluir o aceite do convite.", "err");
          fbWrap.style.display = "block";
          return;
        }

        setStatus("Convite aceito com sucesso. Redirecionando…", "ok");
        // Redireciona para o app; os guards tratarão o papel/rota final
        setTimeout(() => location.href = "/app.html", 800);
      } catch (e) {
        console.error(e);
        alert("Erro inesperado ao aceitar convite.");
        setStatus("Erro inesperado. Tente novamente a partir do e-mail.", "err");
        fbWrap.style.display = "block";
      }
    }

    acceptInvite();
  </script>
</body>
</html>

