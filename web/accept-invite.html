<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aceitar convite — CasaFin</title>
  <style>
    body { font-family: system-ui, Arial; margin:0; background:#f7f7fb; color:#1f2328; }
    .wrap { max-width:560px; margin:10vh auto; background:#fff; padding:24px; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    h1 { font-size:20px; margin:0 0 10px; }
    p { color:#444; }
    .muted { color:#6a737d; font-size: 13px; }
    .btn { padding:10px 14px; border:0; background:#1f883d; color:#fff; border-radius:10px; cursor:pointer; font-weight:600; }
  </style>
  <script src="./config.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Processando seu convite…</h1>
    <p class="muted">Se algo der errado, você poderá tentar novamente pelo link do e-mail.</p>
    <p><button id="go-home" class="btn" style="display:none;">Ir para início</button></p>
  </div>

  <script type="module">
    import { supabase } from "./lib/supabase.js";
    import { redirectByRole } from "./lib/guard.js";

    const params = new URLSearchParams(location.search);
    const token = params.get("token");
    const goHome = document.getElementById("go-home");

    if (!token) {
      alert("Convite inválido: token ausente.");
      goHome.style.display = "inline-block";
    } else {
      const { data, error } = await supabase.rpc("accept_invite", { token });
      if (error || !data) {
        alert(error?.message || "Não foi possível aceitar o convite.");
        goHome.style.display = "inline-block";
      } else {
        // Se não houver sessão ativa, pedir login
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          alert("Convite aceito! Faça login para acessar o espaço.");
          location.href = "/index.html";
        } else {
          await redirectByRole();
        }
      }
    }

    goHome.addEventListener("click", () => location.href = "/index.html");
  </script>
</body>
</html>
